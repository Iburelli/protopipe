

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Energy Look-Up Table &mdash; protopipe 0.4.0.post2.dev128+g9149e12 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Energy estimation for classification" href="benchmarks_DL2_to_classification.html" />
    <link rel="prev" title="Energy estimation (TRAINING)" href="benchmarks_DL2_to_energy-estimation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> protopipe
          

          
          </a>

          
            
            
              <div class="version">
                0.4.0.post2.dev128+g9149e12
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">Workflow and usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">How to contribute</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../gitrepo.html">Code repository layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../instructions.html">Instructions</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../beforepushing.html">Mandatory checks</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../beforepushing.html#documentation">Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../beforepushing.html#testing">Testing</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../beforepushing.html#benchmarks">Benchmarks</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="benchmarks_DL1_calibration.html">Calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="benchmarks_DL1_image-cleaning.html">Image cleaning</a></li>
<li class="toctree-l4"><a class="reference internal" href="benchmarks_DL1_image-cleaning-with-true-phes.html">Parametrized images vs true information (TRAINING)</a></li>
<li class="toctree-l4"><a class="reference internal" href="benchmarks_DL1_DirectionLUT.html">Direction Look-Up-Tables (LUTs)</a></li>
<li class="toctree-l4"><a class="reference internal" href="benchmarks_DL2_direction-reconstruction.html">Direction reconstruction (TRAINING)</a></li>
<li class="toctree-l4"><a class="reference internal" href="benchmarks_DL2_to_energy-estimation.html">Energy estimation (TRAINING)</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Energy Look-Up Table</a></li>
<li class="toctree-l4"><a class="reference internal" href="benchmarks_DL2_to_classification.html">Energy estimation for classification</a></li>
<li class="toctree-l4"><a class="reference internal" href="../MODELS/benchmarks_MODELS_energy.html">Energy reconstruction (MODEL)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../MODELS/benchmarks_MODELS_classification.html">Particle classification (MODEL)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../DL2/benchmarks_DL2_particle-classification.html">Particle classification (DL2)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../DL2/benchmarks_DL2_direction-reconstruction.html">Direction recontruction (DL2)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../DL3/benchmarks_DL3_cuts_optimization.html">Optimization cuts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../DL3/benchmarks_DL3_IRFs_and_sensitivity.html">Instrument Response Functions (IRFs) and sensitivity</a></li>
<li class="toctree-l4"><a class="reference internal" href="../DL3/overall_performance_plot_CTA.html">Performance poster layout</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../AUTHORS.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CHANGELOG.html">Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Structure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline/index.html">pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mva/index.html">mva</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../perf/index.html">perf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/index.html">scripts</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">protopipe</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">How to contribute</a> &raquo;</li>
        
          <li><a href="../../beforepushing.html">Mandatory checks</a> &raquo;</li>
        
      <li>Energy Look-Up Table</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/contribute/benchmarks/TRAINING/benchmarks_DL2_EnergyLUT.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Remove input cells at runtime (nbsphinx)</span>
<span class="kn">import</span> <span class="nn">IPython.core.display</span> <span class="k">as</span> <span class="nn">d</span>
<span class="n">d</span><span class="o">.</span><span class="n">display_html</span><span class="p">(</span><span class="s1">&#39;&lt;script&gt;jQuery(function() {if (jQuery(&quot;body.notebook_app&quot;).length == 0) { jQuery(&quot;.input_area&quot;).toggle(); jQuery(&quot;.prompt&quot;).toggle();}});&lt;/script&gt;&#39;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<script>jQuery(function() {if (jQuery("body.notebook_app").length == 0) { jQuery(".input_area").toggle(); jQuery(".prompt").toggle();}});</script></div>
</div>
<div class="section" id="Energy-Look-Up-Table">
<h1>Energy Look-Up Table<a class="headerlink" href="#Energy-Look-Up-Table" title="Permalink to this headline">¶</a></h1>
<p><strong>Authors:</strong> Michele Peresano &amp; Karl Kosack</p>
<p><strong>Datasample:</strong></p>
<ul class="simple">
<li><p>gamma-1 for training (goes into energy training)</p></li>
<li><p>gamma-2 for testing (goes into classification training because we use estimated energy as one of the features)</p></li>
</ul>
<p><strong>NOTE:</strong> this could be technically merged into the “to_energy-estimation” notebook, since it uses the same (training) data, but it’s also a nice check on its own.</p>
<p><strong>Data level:</strong> DL1b + DL2a (telescope-wise image parameters + shower geometry information)</p>
<p><strong>Scope:</strong></p>
<p>An alternative to more complex machine learning approaches, this LUT allows to estimate the energy of a test event by assigning an average value based on true energy of a training event with some of its reconstructed image parameters and shower geometry.</p>
<p>It can also been used as a benchmark: at a fixed true energy we expect that intensity of the image drops down with increasing impact parameter.</p>
<p><strong>Approach:</strong></p>
<ul class="simple">
<li><p>given intensity and impact parameter of every image/shower pair, build a LUT using true energy as a weight</p></li>
</ul>
<div class="section" id="Table-of-contents">
<h2>Table of contents<a class="headerlink" href="#Table-of-contents" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#LUT-from-training-sample">LUT from training sample</a></p></li>
<li><p><a class="reference external" href="#Use-these-LUTs-to-predict-the-reconstructed-energy">Use these LUTs to predict the reconstructed energy</a></p>
<ul>
<li><p><a class="reference external" href="#Re-apply-them-first-to-the-train-sample">Re-apply them first to the train sample</a></p></li>
<li><p><a class="reference external" href="#Predict-the-reconstructed-energy-of-the-test-sample">Predict the reconstructed energy of the test sample</a></p>
<ul>
<li><p><a class="reference external" href="#Migration-matrix">Migration matrix</a></p></li>
<li><p><a class="reference external" href="#Energy-bias-and-resolution">Energy bias and resolution</a></p></li>
<li><p><a class="reference external" href="#Dispersion-matrix-with-bias-and-resolution">Dispersion matrix with bias and resolution</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binned_statistic</span><span class="p">,</span> <span class="n">binned_statistic_2d</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RectBivariateSpline</span>
<span class="kn">import</span> <span class="nn">tables</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>

<span class="c1"># font size</span>
<span class="n">font_size</span> <span class="o">=</span> <span class="mi">16</span>

<span class="c1"># Set general font size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">font_size</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_camera_names</span><span class="p">(</span><span class="n">inputPath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read the names of the cameras.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    infile : str</span>
<span class="sd">        Full path of the input DL1 file.</span>
<span class="sd">    fileName : str</span>
<span class="sd">        Name of the input DL1 file.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    camera_names : list(str)</span>
<span class="sd">        Table names as a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inputPath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: check input&quot;</span><span class="p">)</span>
    <span class="n">h5file</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inputPath</span><span class="p">,</span> <span class="n">fileName</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">h5file</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">camera_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">_f_list_nodes</span><span class="p">()]</span>
    <span class="n">h5file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">camera_names</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">load_reset_infile_protopipe</span><span class="p">(</span><span class="n">inputPath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">camera_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;(Re)load the file containing DL1(a) data and extract the data per telescope type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    infile : str</span>
<span class="sd">        Full path of the input DL1 file.</span>
<span class="sd">    fileName : str</span>
<span class="sd">        Name of the input DL1 file.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    dataFrames : dict(pandas.DataFrame)</span>
<span class="sd">        Dictionary of tables per camera.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inputPath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: check input&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">camera_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: no cameras specified&quot;</span><span class="p">)</span>
    <span class="c1"># load DL1 images</span>
    <span class="n">dataFrames</span> <span class="o">=</span> <span class="p">{</span><span class="n">camera</span> <span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inputPath</span><span class="p">,</span> <span class="n">fileName</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{camera}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="n">camera_names</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">dataFrames</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">create_lookup_function</span><span class="p">(</span><span class="n">binned_stat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a function f(x,y) that evaluates the lookup at a point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">binned_stat</span><span class="o">.</span><span class="n">x_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">binned_stat</span><span class="o">.</span><span class="n">x_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">binned_stat</span><span class="o">.</span><span class="n">y_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">binned_stat</span><span class="o">.</span><span class="n">y_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">binned_stat</span><span class="o">.</span><span class="n">statistic</span>
    <span class="n">z</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># make sure there are no infs or nans</span>
    <span class="n">interpolator</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">cx</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">cy</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="p">:</span> <span class="n">interpolator</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="c1"># go back to TeV and evaluate</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># EDIT ONLY THIS CELL</span>
<span class="n">analyses_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/Users/michele/Applications/ctasoft/dirac/&quot;</span><span class="p">)</span> <span class="c1"># parent directory of the &#39;shared_folder&#39;</span>
<span class="n">analysisName</span> <span class="o">=</span> <span class="s2">&quot;v0.4.0_dev1&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">analysesPath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;shared_folder/analyses&quot;</span><span class="p">)</span>
<span class="n">train_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/TRAINING/for_energy_estimation&quot;</span><span class="p">)</span>
<span class="n">test_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/TRAINING/for_particle_classification&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">indir_train</span> <span class="o">=</span> <span class="n">analyses_dir</span> <span class="o">/</span> <span class="n">analysesPath</span> <span class="o">/</span> <span class="n">analysisName</span> <span class="o">/</span> <span class="n">train_path</span>
<span class="n">infile_train</span> <span class="o">=</span> <span class="s2">&quot;TRAINING_energy_tail_gamma_merged.h5&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">indir_test</span> <span class="o">=</span> <span class="n">analyses_dir</span> <span class="o">/</span> <span class="n">analysesPath</span> <span class="o">/</span> <span class="n">analysisName</span> <span class="o">/</span> <span class="n">test_path</span>
<span class="n">infile_test</span> <span class="o">=</span> <span class="s2">&quot;TRAINING_classification_tail_gamma_merged.h5&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cameras</span> <span class="o">=</span> <span class="n">get_camera_names</span><span class="p">(</span><span class="n">inputPath</span> <span class="o">=</span> <span class="n">indir_train</span><span class="p">,</span>
                                   <span class="n">fileName</span> <span class="o">=</span> <span class="n">infile_train</span><span class="p">)</span>
<span class="n">data_train</span> <span class="o">=</span> <span class="n">load_reset_infile_protopipe</span><span class="p">(</span><span class="n">inputPath</span> <span class="o">=</span> <span class="n">indir_train</span><span class="p">,</span>
                                   <span class="n">fileName</span> <span class="o">=</span> <span class="n">infile_train</span><span class="p">,</span>
                                   <span class="n">camera_names</span><span class="o">=</span><span class="n">cameras</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">intensity</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">impact_distance</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">true_energy</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># select only successfully reconstructed showers from good images</span>
<span class="n">valid_showers_train</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="n">cameras</span><span class="p">:</span>
    <span class="n">valid_showers_train</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_train</span><span class="p">[</span><span class="n">camera</span><span class="p">][(</span><span class="n">data_train</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;is_valid&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span>
                                                     <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_train</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;good_image&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="n">cameras</span><span class="p">:</span>

    <span class="n">intensity</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_showers_train</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;hillas_intensity_reco&quot;</span><span class="p">]</span>
    <span class="n">impact_distance</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_showers_train</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;impact_dist&quot;</span><span class="p">]</span>
    <span class="n">true_energy</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_showers_train</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;true_energy&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="LUT-from-training-sample">
<h2>LUT from training sample<a class="headerlink" href="#LUT-from-training-sample" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="#Table-of-contents">back to top</a></p>
<p>Few things to notice for interpreting these LUTs:</p>
<ul class="simple">
<li><p>for a fixed intensity, the energy should increase with impact distance because far away showers are fainter,</p></li>
<li><p>any tail in the low-intensity-high-impact regime is (at least) a sign of mis-reconstruction of the shower geometry,</p></li>
<li><p>in the high-intensity-high-impact regime there should be no data, since it’s too below the intensity threshold to be triggered</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">hist_geom</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
                 <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">],</span>  <span class="c1"># log10(intensity)</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">800</span><span class="p">]])</span> <span class="c1"># impact distance</span>
<span class="n">energy_LUT</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">energy_LUT_errors</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">camera</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cameras</span><span class="p">):</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned_statistic_2d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">camera</span><span class="p">]),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">impact_distance</span><span class="p">[</span><span class="n">camera</span><span class="p">],</span>
        <span class="n">values</span><span class="o">=</span><span class="n">true_energy</span><span class="p">[</span><span class="n">camera</span><span class="p">],</span>
        <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">hist_geom</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
        <span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">x_edge</span><span class="p">,</span>
        <span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">y_edge</span><span class="p">,</span>
        <span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">statistic</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(),</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{camera}</span><span class="s2"> - Energy Lookup&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Impact distance (m)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;log10(intensity)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;energy (TeV)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;typical telescope distance&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">energy_LUT_errors</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned_statistic_2d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">camera</span><span class="p">]),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">impact_distance</span><span class="p">[</span><span class="n">camera</span><span class="p">],</span>
        <span class="n">values</span><span class="o">=</span><span class="n">true_energy</span><span class="p">[</span><span class="n">camera</span><span class="p">],</span>
        <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;std&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">hist_geom</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
        <span class="n">energy_LUT_errors</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">x_edge</span><span class="p">,</span>
        <span class="n">energy_LUT_errors</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">y_edge</span><span class="p">,</span>
        <span class="n">energy_LUT_errors</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">statistic</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(),</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{camera}</span><span class="s2"> - Energy Lookup Error&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Impact distance (m)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;log10(intensity)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;std( energy ) (TeV)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_21_0.png" src="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_21_0.png" />
</div>
</div>
</div>
<div class="section" id="Use-these-LUTs-to-predict-the-reconstructed-energy">
<h2>Use these LUTs to predict the reconstructed energy<a class="headerlink" href="#Use-these-LUTs-to-predict-the-reconstructed-energy" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="#Table-of-contents">back to top</a></p>
<p>We should expect that the migration matrix and it’s benchmark energy resolution and bias are less then or at least similar to what we get from the ML model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Get an energy estimator for each camera</span>

<span class="n">energy_estimator</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="n">cameras</span><span class="p">:</span>

    <span class="n">energy_estimator</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_lookup_function</span><span class="p">(</span><span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="Re-apply-them-first-to-the-train-sample">
<h3>Re-apply them first to the train sample<a class="headerlink" href="#Re-apply-them-first-to-the-train-sample" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="#Table-of-contents">back to top</a></p>
<p>The difference between the energy reconstructed with the LUT and the originally binned data should be mostly 0, apart where the error is very high or where relevant DL1 parameters are undefined (but we cut those here).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">camera</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cameras</span><span class="p">):</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">cx</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">x_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>  <span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">x_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">y_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>  <span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">y_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">mx</span><span class="p">,</span> <span class="n">my</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">)</span>
    <span class="n">reco_energy</span> <span class="o">=</span> <span class="n">energy_estimator</span><span class="p">[</span><span class="n">camera</span><span class="p">](</span><span class="n">mx</span><span class="p">,</span><span class="n">my</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">reco_energy</span> <span class="o">-</span> <span class="n">energy_LUT</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span><span class="o">.</span><span class="n">statistic</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;E_reco TEST - E_reco TRAIN [TeV]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;np.log10(intensity) BIN INDEX&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Impact distance [m] BIN INDEX&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_27_0.png" src="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_27_0.png" />
</div>
</div>
</div>
<div class="section" id="Predict-the-reconstructed-energy-of-the-test-sample">
<h3>Predict the reconstructed energy of the test sample<a class="headerlink" href="#Predict-the-reconstructed-energy-of-the-test-sample" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="#Table-of-contents">back to top</a></p>
<p>To be compared with the plots from the DL2 “to classification” notebook</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_test</span> <span class="o">=</span> <span class="n">load_reset_infile_protopipe</span><span class="p">(</span><span class="n">inputPath</span> <span class="o">=</span> <span class="n">indir_test</span><span class="p">,</span>
                                   <span class="n">fileName</span> <span class="o">=</span> <span class="n">infile_test</span><span class="p">,</span>
                                   <span class="n">camera_names</span><span class="o">=</span><span class="n">cameras</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># we select also in this case only events which passed the cuts in the pipeline</span>
<span class="c1"># select only successfully reconstructed showers from good images</span>
<span class="n">valid_showers_test</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="n">cameras</span><span class="p">:</span>
    <span class="n">valid_showers_test</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_test</span><span class="p">[</span><span class="n">camera</span><span class="p">][(</span><span class="n">data_test</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;is_valid&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span>
                                                     <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_test</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;good_image&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="n">cameras</span><span class="p">:</span>

    <span class="n">valid_showers_test</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;reco_energy_LUT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_estimator</span><span class="p">[</span><span class="n">camera</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">valid_showers_test</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;hillas_intensity_reco&quot;</span><span class="p">]),</span>
                                                                             <span class="n">valid_showers_test</span><span class="p">[</span><span class="n">camera</span><span class="p">][</span><span class="s2">&quot;impact_dist&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="Migration-matrix">
<h4>Migration matrix<a class="headerlink" href="#Migration-matrix" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="#Table-of-contents">back to top</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># merge the tables from test data</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">camera</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cameras</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">all_valid_showers_test</span> <span class="o">=</span> <span class="n">valid_showers_test</span><span class="p">[</span><span class="n">camera</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_valid_showers_test</span> <span class="o">=</span> <span class="n">all_valid_showers_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_showers_test</span><span class="p">[</span><span class="n">camera</span><span class="p">])</span>
<span class="c1"># Finally drop duplicate showers (stereo information is the same for each event ID)</span>
<span class="n">unique_all_valid_showers_test</span> <span class="o">=</span> <span class="n">all_valid_showers_test</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">unique_all_valid_showers_test</span><span class="p">[</span><span class="s2">&quot;true_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">unique_all_valid_showers_test</span><span class="p">[</span><span class="s2">&quot;reco_energy_LUT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;log10(true energy) [TeV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;log10(reco energy) [TeV]&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

<span class="kc">None</span> <span class="c1"># to remove clutter by mpl objects</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/michele/Applications/miniconda3/envs/protopipe/lib/python3.7/site-packages/ipykernel_launcher.py:11: RuntimeWarning: divide by zero encountered in log10
  # This is added back by InteractiveShellApp.init_path()
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_34_1.png" src="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_34_1.png" />
</div>
</div>
</div>
<div class="section" id="Energy-bias-and-resolution">
<h4>Energy bias and resolution<a class="headerlink" href="#Energy-bias-and-resolution" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="#Table-of-contents">back to top</a></p>
<p>Considering the distribution,</p>
<p><code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">(E_reco</span> <span class="pre">/</span> <span class="pre">E_true)</span> <span class="pre">-</span> <span class="pre">1</span></code></p>
<p><strong>Energy bias</strong> as the <code class="docutils literal notranslate"><span class="pre">mean</span> <span class="pre">of</span> <span class="pre">x</span></code>, also in bins of true energy.We plot the <strong>bias</strong> as the <code class="docutils literal notranslate"><span class="pre">mean</span> <span class="pre">of</span> <span class="pre">(Erec/Etrue-1)</span></code>, also in bins of true energy.</p>
<p><strong>Energy resolution</strong> is here calculated in bins of true energy - as the <code class="docutils literal notranslate"><span class="pre">68%-quantile</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">distribution</span> <span class="pre">of</span> <span class="pre">abs(x)</span></code>.</p>
<p>Note that by using this definition, any possible reconstruction bias is “absorbed” in the resolution.</p>
<ul class="simple">
<li><p>as the same quantity, but bias-corrected as <code class="docutils literal notranslate"><span class="pre">68%-quantile</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">distribution</span> <span class="pre">of</span> <span class="pre">abs(x</span> <span class="pre">-</span> <span class="pre">bias)</span></code></p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">reco</span> <span class="o">=</span> <span class="n">unique_all_valid_showers_test</span><span class="p">[</span><span class="s2">&quot;reco_energy_LUT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">true</span> <span class="o">=</span> <span class="n">unique_all_valid_showers_test</span><span class="p">[</span><span class="s2">&quot;true_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># from CTAMARS data</span>
<span class="n">bin_edges_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">,</span>
        <span class="mf">0.3</span><span class="p">,</span>  <span class="mf">0.5</span><span class="p">,</span>  <span class="mf">0.7</span><span class="p">,</span>  <span class="mf">0.9</span><span class="p">,</span>  <span class="mf">1.1</span><span class="p">,</span>  <span class="mf">1.3</span><span class="p">,</span>  <span class="mf">1.5</span><span class="p">,</span>  <span class="mf">1.7</span><span class="p">,</span>  <span class="mf">1.9</span><span class="p">,</span>  <span class="mf">2.1</span><span class="p">,</span>  <span class="mf">2.3</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">)</span>
<span class="n">font_size</span> <span class="o">=</span> <span class="mi">16</span>

<span class="c1"># RESOLUTION</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Set tick font size</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">font_size</span><span class="p">)</span>

<span class="n">resolution</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">true</span><span class="p">),</span>
                              <span class="n">reco</span><span class="o">/</span><span class="n">true</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="n">statistic</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">68</span><span class="p">),</span>
                              <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges_x</span><span class="p">,)</span>

<span class="n">corr_resolution</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">true</span><span class="p">),</span>
                                  <span class="n">reco</span><span class="o">/</span><span class="n">true</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">statistic</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="mi">68</span><span class="p">),</span>
                                  <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges_x</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">bin_edges_x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bin_edges_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;bo&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;protopipe&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">bin_edges_x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bin_edges_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">corr_resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;protopipe (bias corrected)&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;log10(true energy) [TeV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;abs(reco/true - 1)_68%&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.1</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

<span class="c1"># BIAS</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Set tick font size</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
    <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">font_size</span><span class="p">)</span>

<span class="n">bias</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">true</span><span class="p">),</span>
                        <span class="n">reco</span><span class="o">/</span><span class="n">true</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
                        <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges_x</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">bin_edges_x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bin_edges_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;bo&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;log10(true energy) [TeV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mean(reco/true - 1)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.1</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="kc">None</span> <span class="c1"># to remove clutter by mpl objects</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_37_0.png" src="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_37_0.png" />
</div>
</div>
</div>
<div class="section" id="Dispersion-matrix-with-bias-and-resolution">
<h4>Dispersion matrix with bias and resolution<a class="headerlink" href="#Dispersion-matrix-with-bias-and-resolution" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="#Table-of-contents">back to top</a></p>
<p>Here the error bar is the bias-corrected resolution.</p>
<p>The dispersion matrix has been normalized to ensure that the integral probability of reconstructing a photon with a certain true energy at a certain reconstructed energy is 1.0</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">reco</span><span class="o">/</span><span class="n">true</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">bin_edges_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">300</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges_x</span><span class="p">,</span> <span class="n">bin_edges_y</span><span class="p">])</span>
<span class="c1"># normalize y-axis so to get a max probability of 1 within 1 bin in true energy</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
<span class="c1"># re-plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">bin_edges_x</span><span class="p">,</span> <span class="n">bin_edges_y</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>


<span class="n">corr_resolution</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">true</span><span class="p">),</span>
                                  <span class="n">reco</span><span class="o">/</span><span class="n">true</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">statistic</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="mi">68</span><span class="p">),</span>
                                  <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges_x</span><span class="p">)</span>

<span class="n">bias</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">true</span><span class="p">),</span>
                        <span class="n">reco</span><span class="o">/</span><span class="n">true</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
                        <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges_x</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">bin_edges_x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bin_edges_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
             <span class="n">y</span> <span class="o">=</span> <span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">xerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bin_edges_x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
             <span class="n">yerr</span> <span class="o">=</span> <span class="n">corr_resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
             <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.03</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;30 GeV&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;log10(true energy) [TeV]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;reco / true - 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="kc">None</span> <span class="c1"># to remove clutter by mpl objects</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_40_0.png" src="../../../_images/contribute_benchmarks_TRAINING_benchmarks_DL2_EnergyLUT_40_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="benchmarks_DL2_to_classification.html" class="btn btn-neutral float-right" title="Energy estimation for classification" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="benchmarks_DL2_to_energy-estimation.html" class="btn btn-neutral float-left" title="Energy estimation (TRAINING)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Michele Peresano.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>